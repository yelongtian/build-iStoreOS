name: ğŸ’¿ StX_Build-iStoreOS-src
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      openwrt_board:
        description: "è¯·é€‰æ‹©è®¾å¤‡å‹å·"
        required: true
        default: "jp-tvbox_wxy-oect_fine3399_dg-tn3568"
        type: choice
        options:
          - jp-tvbox_wxy-oect_fine3399_dg-tn3568
          - a311d
          - a311d-oes
          - alark35-3500
          - anas3035
          - beikeyun
          - chainedbox
          - crrc
          - dc-a588
          - dg3399
          - dg-tn3568
          - dlfr100
          - e20c
          - e25
          - eaidk-610
          - emb3531
          - fine3399
          - firefly-rk3399
          - fmx1-pro
          - jp-tvbox
          - h28k
          - h66k
          - h68k
          - h69k
          - h88k
          - h88k-v3
          - h96-max-m2
          - hs530r
          - hugsun-x99
          - ipc-r
          - king3399
          - kylin3399
          - lckfb-tspi
          - leez
          - lx-r3s
          - mrkaio-m68s
          - nanopc-t6
          - nanopi-r5c
          - nanopi-r5s
          - orangepi-5-plus
          - orangepi-5b
          - panther-x2
          - r66s
          - r68s
          - renegade-rk3328
          - rk3318-box
          - rock5b
          - rock5c
          - rp-rk3568
          - ruisen-box
          - seewo-sv21
          - smart-am40
          - smart-am60
          - station-m1
          - station-m2
          - sv-33a6x
          - swan1-w28
          - sw799
          - tanix-tx6
          - tb-ls3399
          - tn3399
          - tpm312
          - tqc-a01
          - tvi3315a
          - vplus
          - wocyber-a3
          - wxy-oect
          - wxy-oect-replaced
          - xiaobao
          - yskj
          - zcube1-max
          - zk-r39a
          - zysj
      openwrt_kernel:
        description: "è¯·é€‰æ‹©å†…æ ¸ç‰ˆæœ¬ï¼ˆè‹¥æœªåŒ¹é…åˆ™è‡ªåŠ¨ï¼‰"
        required: true
        default: "6.6.y"
        type: choice
        options:
          - 5.10.y
          - 5.15.y
          - 6.1.y
          - 6.6.y
          - 6.12.y

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write  # å…³é”®ï¼šæ˜ç¡®èµ‹äºˆReleaseå†™å…¥æƒé™ï¼ˆè‡ªå®šä¹‰Tokenä¹Ÿå»ºè®®æ·»åŠ ï¼‰
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: â¬ ä¸‹è½½ rootfs.tar.gz
        run: |
          echo "ğŸ“¦ æ­£åœ¨ä¸‹è½½é¢„æ„å»º rootfs"
          mkdir -p bin/targets/armsr/armv8
          curl -L -o bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz \
            https://github.com/Kwonelee/Rootfs-Actions/releases/download/generic-rootfs/istoreos-armsr-armv8-generic-rootfs.tar.gz

      - name: ğŸ” æŸ¥æ‰¾rootfs.tar.gzæ‰€åœ¨è·¯å¾„
        id: find_rootfs
        run: |
          ROOTFS_FILE=$(find bin/targets/armsr/armv8/ -type f -name "*rootfs.tar.gz" | head -n1)
          echo "âœ… Found: $ROOTFS_FILE"
          if [ ! -f "$ROOTFS_FILE" ]; then
            echo "âŒ æ‰¾ä¸åˆ° rootfs.tar.gz æ–‡ä»¶"
            exit 1
          fi
          echo "file=$ROOTFS_FILE" >> $GITHUB_OUTPUT

      - name: ğŸ§± æ‰“åŒ…iStoreOSå›ºä»¶
        uses: Kwonelee/amlogic-s9xxx-openwrt@main
        with:
          openwrt_path: ${{ steps.find_rootfs.outputs.file }}
          openwrt_board: ${{ inputs.openwrt_board }}
          openwrt_kernel: ${{ inputs.openwrt_kernel }}
          auto_kernel: true
          kernel_repo: ophub/kernel
          kernel_usage: stable
          builder_name: kwonelee

      - name: ğŸ“œ è°ƒæ•´.img.gz æ–‡ä»¶å
        id: rename
        run: |
          # ç¡®ä¿æ‰“åŒ…è¾“å‡ºç›®å½•å­˜åœ¨
          if [ ! -d "${{ env.PACKAGED_OUTPUTPATH }}" ]; then
            echo "âŒ æ‰“åŒ…è¾“å‡ºç›®å½•ä¸å­˜åœ¨ï¼š${{ env.PACKAGED_OUTPUTPATH }}"
            exit 1
          fi
          # æ‰¹é‡é‡å‘½åæ–‡ä»¶
          for FILE in ${{ env.PACKAGED_OUTPUTPATH }}/*.img.gz; do
            if [ -f "$FILE" ]; then
              FILENAME=$(basename "$FILE")
              NEW_FILENAME=$(echo "$FILENAME" | sed 's/openwrt/istoreos_24.10.2/g')
              mv "$FILE" "${{ env.PACKAGED_OUTPUTPATH }}/$NEW_FILENAME"
              echo "âœ… é‡å‘½åï¼š$FILENAME â†’ $NEW_FILENAME"
            else
              echo "âš ï¸  æœªæ‰¾åˆ° .img.gz æ–‡ä»¶"
              exit 1
            fi
          done

      - name: ğŸš€ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2.2.1
        with:
          tag_name: iStoreOS-24.10-SNAPSHOT-dhcp
          body: |
            ğŸ”„ ç‰ˆæœ¬ï¼š iStoreOS-24.10.2-SNAPSHOTï¼ˆæºç ç¼–è¯‘ï¼Œè¿½æ–°ç‰ˆï¼‰
            
            ğŸ“‚ æ¥æºï¼š https://github.com/istoreos/istoreos
            
            ğŸ§  å†…æ ¸ï¼š Please Login to iStoreOS â†’ System â†’ Amlogic Service â†’ Replace the Kernel
            
            ğŸ§© é›†æˆï¼š åŒ…å«äº†åŸºç¡€ç³»ç»Ÿç»„ä»¶ã€é©±åŠ¨ã€ç½‘ç»œå·¥å…·ã€å®¹å™¨æ”¯æŒã€LuCIç•Œé¢åŠæ’ä»¶ç­‰ã€‚ä¸å®˜æ–¹é›†æˆåˆ—è¡¨åŸºæœ¬ä¸€è‡´
            
            ğŸ‘¤ ç”¨æˆ·åï¼š root
            
            ğŸ”’ å¯†ç ï¼š æ— 
            
            ğŸŒ IPï¼š å•ç½‘å£-åŠ¨æ€è·å–ï¼ˆä»ä¸Šçº§è·¯ç”±æ‰¾å¯»ï¼‰ï¼›å¤šç½‘å£-IPï¼š192.168.100.1
          files: |
            ${{ env.PACKAGED_OUTPUTPATH }}/*.img.gz
          draft: false  # ç›´æ¥å‘å¸ƒæ­£å¼Releaseï¼ˆå¯é€‰ï¼štrueä¸ºè‰ç¨¿ï¼‰
          prerelease: false  # éé¢„å‘å¸ƒç‰ˆæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}  # æ²¿ç”¨ä½ çš„è‡ªå®šä¹‰Token
